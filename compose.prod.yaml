name: chronoverse

x-limits:
  # Database requires more cpu and memory
  database-limits: &database-limits
    deploy:
      resources:
        limits:
          cpus: "1" # 1 CPU
          memory: 1G # 1Â GB
        reservations:
          cpus: "0.5" # 500Â m CPU
          memory: 512M # 512Â MB

  # Services require less cpu and memory
  services-limit: &services-limit
    deploy:
      resources:
        limits:
          cpus: "0.25" # 250Â m CPU
          memory: 256M # 256Â MB
        reservations:
          cpus: "0.1" # 100Â m CPU
          memory: 128M # 128Â MB

  # Low resources workers require a bit more cpu and memory
  # but still less than the database
  low-resources-workers-limit: &low-resources-workers-limit
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "0.5" # 500Â m CPU
          memory: 2G # 2Â GB
        reservations:
          cpus: "0.25" # 250Â m CPU
          memory: 1G # 1Â GB

  # High resources workers require a bit more cpu and memory
  high-resources-workers-limit: &high-resources-workers-limit
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "2" # 2 CPU
          memory: 4G # 4Â GB
        reservations:
          cpus: "1" # 1 CPU
          memory: 2G # 2Â GB

services:
  postgres:
    <<: *database-limits
    image: postgres:18.0-alpine3.22
    container_name: postgres
    environment:
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
    restart: on-failure
    volumes:
      - postgres:/var/lib/postgresql
      - ./certs:/certs:ro
      - ./certs/postgres/config:/etc/postgresql
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "psql 'host=0.0.0.0 user=primary dbname=postgres sslmode=verify-full sslrootcert=/certs/ca/ca.crt sslcert=/certs/clients/client.crt sslkey=/certs/clients/client.key' -c 'SELECT 1;'",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      init-certs:
        condition: service_completed_successfully
    networks:
      - chronoverse

  clickhouse:
    <<: *database-limits
    image: clickhouse:25.8.7.3
    container_name: clickhouse
    environment:
      CLICKHOUSE_USER: chronoverse-client
      CLICKHOUSE_PASSWORD: chronoverse
    restart: on-failure
    volumes:
      - clickhouse:/var/lib/clickhouse
      - ./certs/clickhouse:/etc/clickhouse-server/certs:ro
      - ./certs/ca:/etc/clickhouse-server/ca:ro
      - ./certs/clickhouse/config:/etc/clickhouse-server/conf.d:ro
      - ./certs/clickhouse/clients/config.xml:/etc/clickhouse-client/config.xml:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "clickhouse-client --secure --host=localhost --port=9440 --user=chronoverse-client --password=chronoverse --query 'SELECT 1'",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s
    depends_on:
      init-certs:
        condition: service_completed_successfully
    networks:
      - chronoverse

  redis:
    <<: *database-limits
    image: redis:8.2.1-alpine
    container_name: redis
    restart: on-failure
    volumes:
      - redis:/data
      - ./certs:/certs:ro
    command:
      [
        "--port 0",
        "--tls-port 6379",
        "--tls-cert-file /certs/redis/redis.crt",
        "--tls-key-file /certs/redis/redis.key",
        "--tls-ca-cert-file /certs/ca/ca.crt",
        "--tls-auth-clients yes",
      ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "redis-cli --tls --cert /certs/clients/client.crt --key /certs/clients/client.key --cacert /certs/ca/ca.crt -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s
    depends_on:
      init-certs:
        condition: service_completed_successfully
    networks:
      - chronoverse

  meilisearch:
    image: getmeili/meilisearch:v1.15.0
    container_name: meilisearch
    restart: on-failure
    environment:
      MEILI_MASTER_KEY: 35b09c3c7b1001ed1fbed7db29a155d0201ab22d527b41bfba9003da7bb3b404
      MEILI_SSL_AUTH_PATH: /certs/ca/ca.crt
      MEILI_SSL_CERT_PATH: /certs/meilisearch/meilisearch.crt
      MEILI_SSL_KEY_PATH: /certs/meilisearch/meilisearch.key
      ENV: production
    volumes:
      - meilisearch:/meili_data
      - ./certs:/certs:ro
    depends_on:
      init-certs:
        condition: service_completed_successfully
    healthcheck:
      test: |
        sh -c '
          if [ -n "$$MEILI_SSL_AUTH_PATH" ] && [ -n "$$MEILI_SSL_CERT_PATH" ] && [ -n "$$MEILI_SSL_KEY_PATH" ]; then
            curl --cert "$$MEILI_SSL_CERT_PATH" --key "$$MEILI_SSL_KEY_PATH" --cacert "$$MEILI_SSL_AUTH_PATH" -f https://meilisearch:7700/health
          else
            curl -f http://meilisearch:7700/health
          fi
        '
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chronoverse

  kafka:
    <<: *database-limits
    image: confluentinc/cp-kafka:7.6.7
    hostname: kafka
    container_name: kafka
    restart: on-failure
    environment:
      KAFKA_KRAFT_MODE: "true"
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: controller,broker
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_LISTENERS: SSL://kafka:9094,CONTROLLER://kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SSL:SSL,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SSL
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_ADVERTISED_LISTENERS: SSL://kafka:9094

      # SSL config...
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.keystore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: keystore_creds.txt
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: truststore_creds.txt
      KAFKA_SSL_KEY_CREDENTIALS: key_creds.txt
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.truststore.jks
      KAFKA_SSL_CLIENT_AUTH: required
      KAFKA_SSL_ENABLED_PROTOCOLS: TLSv1.2,TLSv1.3
      KAFKA_SSL_PROTOCOL: TLS

      KAFKA_LOG_DIRS: /var/lib/kafka/data

      # Internal topics replication factors
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1

      # Ensure min ISR = 1 for single-broker
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Optional: global default
      KAFKA_MIN_INSYNC_REPLICAS: 1

      # Other Confluent internal topics left at RF=1
      KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CLUSTER_LINK_METADATA_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONFLUENT_CLUSTER_LINK_METADATA_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONFLUENT_DURABILITY_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONFLUENT_TIER_METADATA_REPLICATION_FACTOR: 1
      KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR: 1

      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CLUSTER_ID: EDofQNqcSCa63isOyHHO9g
    volumes:
      - kafka:/var/lib/kafka/data
      - ./certs/kafka:/etc/kafka/secrets:ro
    depends_on:
      init-certs:
        condition: service_completed_successfully
    networks:
      - chronoverse

  lgtm:
    image: grafana/otel-lgtm:0.11.10
    container_name: lgtm
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: true
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    restart: on-failure
    volumes:
      - lgtm:/data
      - otel-lgtm:/otel-lgtm
    ports:
      - "3000:3000"
    networks:
      - chronoverse

  docker-proxy:
    <<: *services-limit
    image: tecnativa/docker-socket-proxy:v0.4.1
    container_name: docker-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Image-related permissions
      IMAGES: 1
      IMAGE_CREATE: 1

      # Container-related permissions
      CONTAINERS: 1 # Basic container operations
      CONTAINER_CREATE: 1 # Needed for ContainerCreate
      CONTAINER_START: 1 # Needed for ContainerStart
      CONTAINER_LOGS: 1 # Needed for streaming logs
      CONTAINER_ATTACH: 1 # Might be needed for log streaming
      CONTAINER_WAIT: 1 # Needed for waiting on container exit
      CONTAINER_DELETE: 1 # Needed for container cleanup
      CONTAINER_STOP: 1 # Might be needed to stop containers

      # General permissions
      POST: 1 # Allow POST requests
      AUTH: 1 # Allow registry authentication

      # Network permissions
      NETWORKS: 0
      VOLUMES: 0
    networks:
      - chronoverse

  init-certs:
    image: alpine:3.22.2
    container_name: init-certs
    volumes:
      - ./certs:/certs:rw
    entrypoint: |
      sh -c '
        if [ -f /certs/auth.ed ] && [ -f /certs/auth.ed.pub ]; then
          echo "âœ… Certificates already exist, skipping generation"
        else
          echo "ðŸ” Generating new certificates..."
          apk update
          apk add --no-cache openssl
          openssl genpkey -algorithm ED25519 -outform pem -out /certs/auth.ed
          openssl pkey -in /certs/auth.ed -pubout -out /certs/auth.ed.pub
          echo "âœ… Certificates generated successfully"
        fi

        echo "Setting certificate permissions..."
        chmod 444 /certs/auth.ed.pub
        chmod 444 /certs/auth.ed
        echo "ðŸŽ‰ Certificate permissions set successfully"

        echo "ðŸ” Initializing TLS certificates for services..."

        apk update && apk add --no-cache openssl openjdk11-jre-headless
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk

        mkdir -p /certs/ca
        # Generate CA if not exists
        if [ ! -f /certs/ca/ca.key ]; then
          echo "ðŸ›¡ï¸ Generating CA certificate..."
          openssl genrsa -out /certs/ca/ca.key 4096
          openssl req -x509 -new -nodes -key /certs/ca/ca.key -sha256 \
            -days 365 -out /certs/ca/ca.crt \
            -subj "/CN=chronoverse-ca"
          echo "âœ… CA certificate created"
        fi

        SERVICES="postgres redis clickhouse kafka meilisearch users-service workflows-service jobs-service notifications-service analytics-service"
        for svc in $$SERVICES; do
          mkdir -p /certs/$$svc

          if [ ! -f /certs/$$svc/$$svc.key ]; then
            CERT_PATH="/certs/$$svc"
            echo "ðŸ”§ Generating certificate for $$svc..."
            openssl genrsa -out "$$CERT_PATH/$$svc.key" 4096
            openssl req -new -key "$$CERT_PATH/$$svc.key" \
              -out "$$CERT_PATH/$$svc.csr" \
              -subj "/CN=chronoverse-$$svc"

            echo "subjectAltName=IP:0.0.0.0,IP:127.0.0.1,DNS:$$svc" > "$$CERT_PATH/$$svc-ext.cnf"

            openssl x509 -req -in "$$CERT_PATH/$$svc.csr" \
              -CA /certs/ca/ca.crt -CAkey /certs/ca/ca.key \
              -CAcreateserial -out "$$CERT_PATH/$$svc.crt" -days 365 \
              -extfile "$$CERT_PATH/$$svc-ext.cnf"

            rm "$$CERT_PATH/$$svc.csr" "$$CERT_PATH/$$svc-ext.cnf"

            echo "âœ… Certificate created for $$svc"
          fi
        done

        # Convert Kafka PEM to PKCS12
        echo "ðŸ”„ Converting Kafka PEM to PKCS12..."
        openssl pkcs12 -export \
          -in /certs/kafka/kafka.crt \
          -inkey /certs/kafka/kafka.key \
          -certfile /certs/ca/ca.crt \
          -out /certs/kafka/kafka.p12 \
          -name kafka \
          -password pass:chronoverse

        # Import PKCS12 to JKS keystore
        echo "ðŸ”„ Importing PKCS12 to JKS keystore..."
        keytool -importkeystore \
          -deststorepass chronoverse \
          -destkeypass chronoverse \
          -destkeystore /certs/kafka/kafka.keystore.jks \
          -srckeystore /certs/kafka/kafka.p12 \
          -srcstoretype PKCS12 \
          -srcstorepass chronoverse \
          -alias kafka

        # Create Kafka truststore
        echo "ðŸ”„ Creating Kafka truststore..."
        keytool -import -trustcacerts -alias CARoot \
          -file /certs/ca/ca.crt \
          -keystore /certs/kafka/kafka.truststore.jks \
          -storepass chronoverse -noprompt

        # Client certificate for mTLS
        echo "ðŸ” Generating client certificate for mTLS..."
        mkdir -p /certs/clients
        if [ ! -f /certs/clients/client.key ]; then
          openssl genrsa -out /certs/clients/client.key 4096
          openssl req -new -key /certs/clients/client.key \
            -out /certs/clients/client.csr \
            -subj "/CN=chronoverse-client"

          echo "subjectAltName=DNS:client" > /certs/clients/client-ext.cnf

          openssl x509 -req -in /certs/clients/client.csr \
            -CA /certs/ca/ca.crt -CAkey /certs/ca/ca.key \
            -CAcreateserial -out /certs/clients/client.crt -days 365 \
            -extfile /certs/clients/client-ext.cnf

          rm /certs/clients/client.csr /certs/clients/client-ext.cnf
          rm /certs/ca/ca.srl
          echo "âœ… Client certificate created"
        fi

        echo "ðŸ” Setting permissions for all certificates..."

        chmod 444 /certs/ca/ca.crt
        chmod 444 /certs/ca/ca.key

        chmod 444 /certs/kafka/kafka.crt /certs/kafka/kafka.key /certs/kafka/kafka.keystore.jks /certs/kafka/kafka.truststore.jks

        echo "ðŸ” Creating Kafka keystore credentials files..."
        echo "chronoverse" > /certs/kafka/keystore_creds.txt
        echo "chronoverse" > /certs/kafka/truststore_creds.txt
        echo "chronoverse" > /certs/kafka/key_creds.txt
        chmod 444 /certs/kafka/*_creds.txt

        for svc in $$SERVICES; do
          chmod 444 /certs/$$svc/$$svc.crt
          chmod 444 /certs/$$svc/$$svc.key
        done

        chmod 600 /certs/postgres/postgres.key
        chmod 600 /certs/clients/client.key

        chmod 444 /certs/clients/client.crt

        # ClickHouse server files: make readable by clickhouse user (UID/GID 101).
        chown 101:101 /certs/clickhouse/clickhouse.key /certs/clickhouse/clickhouse.crt
        chmod 640 /certs/clickhouse/clickhouse.key
        chmod 444 /certs/clickhouse/clickhouse.crt

        # Create ClickHouse-specific copies of client certs for mTLS inside the ClickHouse container.
        mkdir -p /certs/clickhouse/clients
        cp -f /certs/clients/client.key /certs/clickhouse/clients/client.key
        cp -f /certs/clients/client.crt /certs/clickhouse/clients/client.crt
        chown 101:101 /certs/clickhouse/clients/client.key /certs/clickhouse/clients/client.crt
        chmod 640 /certs/clickhouse/clients/client.key
        chmod 444 /certs/clickhouse/clients/client.crt

        echo "âœ… Permissions set successfully"

        mkdir -p /certs/postgres/config
        POSTGRES_CONF=/certs/postgres/config/postgresql.conf
        POSTGRES_HBA_CONF=/certs/postgres/config/pg_hba.conf

        if [ ! -f "$$POSTGRES_CONF" ]; then
          echo "ðŸ“ Creating postgresql.conf..."

          echo "listen_addresses='\''*'\''" > "$$POSTGRES_CONF"
          echo "ssl=on" >> "$$POSTGRES_CONF"
          echo "ssl_cert_file='\''/certs/postgres/postgres.crt'\''" >> "$$POSTGRES_CONF"
          echo "ssl_key_file='\''/certs/postgres/postgres.key'\''" >> "$$POSTGRES_CONF"
          echo "ssl_ca_file='\''/certs/ca/ca.crt'\''" >> "$$POSTGRES_CONF"
          echo "ssl_max_protocol_version='\''TLSv1.3'\''" >> "$$POSTGRES_CONF"
          echo "password_encryption='\''scram-sha-256'\''" >> "$$POSTGRES_CONF"
        fi

        if [ ! -f "$$POSTGRES_HBA_CONF" ]; then
          echo "ðŸ“ Creating pg_hba.conf..."

          echo "# TYPE  DATABASE        USER            ADDRESS                 METHOD" > "$$POSTGRES_HBA_CONF"
          echo "hostssl all             all             0.0.0.0/0               scram-sha-256 clientcert=verify-full" >> "$$POSTGRES_HBA_CONF"
        fi

        mkdir -p /certs/clickhouse/config
        CLICKHOUSE_TLS_CONF=/certs/clickhouse/config/tls.xml
        CLICKHOUSE_USERS_CONF=/certs/clickhouse/config/users.xml
        CLICKHOUSE_CLIENT_CONF=/certs/clickhouse/clients/config.xml

        cat > "$$CLICKHOUSE_TLS_CONF" << 'EOF'
      <?xml version="1.0"?>
      <clickhouse>
        <tcp_port>0</tcp_port>
        <tcp_port_secure>9440</tcp_port_secure>
        <openSSL>
          <server>
            <certificateFile>/etc/clickhouse-server/certs/clickhouse.crt</certificateFile>
            <privateKeyFile>/etc/clickhouse-server/certs/clickhouse.key</privateKeyFile>
            <caConfig>/etc/clickhouse-server/ca/ca.crt</caConfig>
            <verificationMode>strict</verificationMode>
            <minVersion>TLSv1_2</minVersion>
            <maxVersion>TLSv1_3</maxVersion>
          </server>
          <client>
            <loadDefaultCAFile>false</loadDefaultCAFile>
            <certificateFile>/etc/clickhouse-server/certs/clients/client.crt</certificateFile>
            <privateKeyFile>/etc/clickhouse-server/certs/clients/client.key</privateKeyFile>
            <caConfig>/etc/clickhouse-server/ca/ca.crt</caConfig>
            <verificationMode>strict</verificationMode>
            <minVersion>TLSv1_2</minVersion>
          </client>
        </openSSL>
      </clickhouse>
      EOF

        cat > "$$CLICKHOUSE_USERS_CONF" << 'EOF'
      <?xml version="1.0"?>
      <clickhouse>
        <users>
          <chronoverse-client>
            <password>chronoverse</password>
            <networks>
              <ip>::/0</ip>
              <ip>0.0.0.0/0</ip>
            </networks>
            <profile>default</profile>
            <quota>default</quota>
          </chronoverse-client>
        </users>
      </clickhouse>
      EOF

        cat > "$$CLICKHOUSE_CLIENT_CONF" << 'EOF'
      <?xml version="1.0"?>
      <config>
        <secure>true</secure>
        <openSSL>
          <client>
            <certificateFile>/etc/clickhouse-server/certs/clients/client.crt</certificateFile>
            <privateKeyFile>/etc/clickhouse-server/certs/clients/client.key</privateKeyFile>
            <caConfig>/etc/clickhouse-server/ca/ca.crt</caConfig>
            <verificationMode>strict</verificationMode>
            <minVersion>TLSv1_2</minVersion>
          </client>
        </openSSL>
      </config>
      EOF

        echo "ðŸŽ‰ TLS certificates initialized successfully!"
      '
    restart: "no"
    networks:
      - chronoverse

  init-database-migration:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/database-migration:latest
    container_name: init-database-migration
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      CLICKHOUSE_HOSTS: clickhouse:9440
      CLICKHOUSE_USERNAME: chronoverse-client
      CLICKHOUSE_PASSWORD: chronoverse
      CLICKHOUSE_TLS_ENABLED: true
      CLICKHOUSE_TLS_CA_FILE: certs/ca/ca.crt
      CLICKHOUSE_TLS_CERT_FILE: certs/clients/client.crt
      CLICKHOUSE_TLS_KEY_FILE: certs/clients/client.key
      MEILISEARCH_URI: https://meilisearch:7700
      MEILISEARCH_MASTER_KEY: 35b09c3c7b1001ed1fbed7db29a155d0201ab22d527b41bfba9003da7bb3b404
      MEILISEARCH_TLS_ENABLED: true
      MEILISEARCH_TLS_CA_FILE: certs/ca/ca.crt
      MEILISEARCH_TLS_CERT_FILE: certs/clients/client.crt
      MEILISEARCH_TLS_KEY_FILE: certs/clients/client.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: "no"
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
    networks:
      - chronoverse

  users-service:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/users-service:latest
    container_name: users-service
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      GRPC_PORT: 50051
      GRPC_TLS_ENABLED: true
      GRPC_TLS_CA_FILE: certs/ca/ca.crt
      GRPC_TLS_CERT_FILE: certs/users-service/users-service.crt
      GRPC_TLS_KEY_FILE: certs/users-service/users-service.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    healthcheck:
      test: |
        if [ "$$GRPC_TLS_ENABLED" = "true" ]; then
          /bin/grpc-health-probe -addr=localhost:50051 -connect-timeout 250ms -rpc-timeout 250ms -tls -tls-ca-cert certs/ca/ca.crt -tls-client-cert certs/users-service/users-service.crt -tls-client-key certs/users-service/users-service.key -tls-server-name=users-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        else
          /bin/grpc-health-probe -addr=localhost:50051 -connect-timeout 250ms -rpc-timeout 250ms -service=users-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        fi
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  workflows-service:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/workflows-service:latest
    container_name: workflows-service
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      GRPC_PORT: 50052
      GRPC_TLS_ENABLED: true
      GRPC_TLS_CA_FILE: certs/ca/ca.crt
      GRPC_TLS_CERT_FILE: certs/workflows-service/workflows-service.crt
      GRPC_TLS_KEY_FILE: certs/workflows-service/workflows-service.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    healthcheck:
      test: |
        if [ "$$GRPC_TLS_ENABLED" = "true" ]; then
          /bin/grpc-health-probe -addr=localhost:50052 -connect-timeout 250ms -rpc-timeout 250ms -tls -tls-ca-cert certs/ca/ca.crt -tls-client-cert certs/workflows-service/workflows-service.crt -tls-client-key certs/workflows-service/workflows-service.key -tls-server-name=workflows-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        else
          /bin/grpc-health-probe -addr=localhost:50052 -connect-timeout 250ms -rpc-timeout 250ms -service=workflows-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        fi
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  jobs-service:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/jobs-service:latest
    container_name: jobs-service
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      CLICKHOUSE_HOSTS: clickhouse:9440
      CLICKHOUSE_USERNAME: chronoverse-client
      CLICKHOUSE_PASSWORD: chronoverse
      CLICKHOUSE_TLS_ENABLED: true
      CLICKHOUSE_TLS_CA_FILE: certs/ca/ca.crt
      CLICKHOUSE_TLS_CERT_FILE: certs/clients/client.crt
      CLICKHOUSE_TLS_KEY_FILE: certs/clients/client.key
      MEILISEARCH_URI: https://meilisearch:7700
      MEILISEARCH_MASTER_KEY: 35b09c3c7b1001ed1fbed7db29a155d0201ab22d527b41bfba9003da7bb3b404
      MEILISEARCH_TLS_ENABLED: true
      MEILISEARCH_TLS_CA_FILE: certs/ca/ca.crt
      MEILISEARCH_TLS_CERT_FILE: certs/clients/client.crt
      MEILISEARCH_TLS_KEY_FILE: certs/clients/client.key
      GRPC_PORT: 50053
      GRPC_TLS_ENABLED: true
      GRPC_TLS_CA_FILE: certs/ca/ca.crt
      GRPC_TLS_CERT_FILE: certs/jobs-service/jobs-service.crt
      GRPC_TLS_KEY_FILE: certs/jobs-service/jobs-service.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    healthcheck:
      test: |
        if [ "$$GRPC_TLS_ENABLED" = "true" ]; then
          /bin/grpc-health-probe -addr=localhost:50053 -connect-timeout 250ms -rpc-timeout 250ms -tls -tls-ca-cert certs/ca/ca.crt -tls-client-cert certs/jobs-service/jobs-service.crt -tls-client-key certs/jobs-service/jobs-service.key -tls-server-name=jobs-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        else
          /bin/grpc-health-probe -addr=localhost:50053 -connect-timeout 250ms -rpc-timeout 250ms -service=jobs-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        fi
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  notifications-service:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/notifications-service:latest
    container_name: notifications-service
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      GRPC_PORT: 50054
      GRPC_TLS_ENABLED: true
      GRPC_TLS_CA_FILE: certs/ca/ca.crt
      GRPC_TLS_CERT_FILE: certs/notifications-service/notifications-service.crt
      GRPC_TLS_KEY_FILE: certs/notifications-service/notifications-service.key
      CLIENT_TLS_CERT_FILE: certs/clients/client.crt
      CLIENT_TLS_KEY_FILE: certs/clients/client.key
      USERS_SERVICE_HOST: users-service
      USERS_SERVICE_PORT: 50051
      USERS_SERVICE_TLS_ENABLED: true
      USERS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    healthcheck:
      test: |
        if [ "$$GRPC_TLS_ENABLED" = "true" ]; then
          /bin/grpc-health-probe -addr=localhost:50054 -connect-timeout 250ms -rpc-timeout 250ms -tls -tls-ca-cert certs/ca/ca.crt -tls-client-cert certs/notifications-service/notifications-service.crt -tls-client-key certs/notifications-service/notifications-service.key -tls-server-name=notifications-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        else
          /bin/grpc-health-probe -addr=localhost:50054 -connect-timeout 250ms -rpc-timeout 250ms -service=notifications-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        fi
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
      users-service:
        condition: service_healthy
    networks:
      - chronoverse

  analytics-service:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/analytics-service:latest
    container_name: analytics-service
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      GRPC_PORT: 50055
      GRPC_TLS_ENABLED: true
      GRPC_TLS_CA_FILE: certs/ca/ca.crt
      GRPC_TLS_CERT_FILE: certs/analytics-service/analytics-service.crt
      GRPC_TLS_KEY_FILE: certs/analytics-service/analytics-service.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    healthcheck:
      test: |
        if [ "$$GRPC_TLS_ENABLED" = "true" ]; then
          /bin/grpc-health-probe -addr=localhost:50055 -connect-timeout 250ms -rpc-timeout 250ms -tls -tls-ca-cert certs/ca/ca.crt -tls-client-cert certs/analytics-service/analytics-service.crt -tls-client-key certs/analytics-service/analytics-service.key -tls-server-name=analytics-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        else
          /bin/grpc-health-probe -addr=localhost:50055 -connect-timeout 250ms -rpc-timeout 250ms -service=analytics-service -rpc-header=Audience:grpc_probe -rpc-header=Role:admin
        fi
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  scheduling-worker:
    <<: *low-resources-workers-limit
    image: ghcr.io/hitesh22rana/chronoverse/scheduling-worker:latest
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  workflow-worker:
    <<: *low-resources-workers-limit
    image: ghcr.io/hitesh22rana/chronoverse/workflow-worker:latest
    environment:
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      CLICKHOUSE_HOSTS: clickhouse:9440
      CLICKHOUSE_USERNAME: chronoverse-client
      CLICKHOUSE_PASSWORD: chronoverse
      CLICKHOUSE_TLS_ENABLED: true
      CLICKHOUSE_TLS_CA_FILE: certs/ca/ca.crt
      CLICKHOUSE_TLS_CERT_FILE: certs/clients/client.crt
      CLICKHOUSE_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_CONSUMER_GROUP: workflow-worker
      CLIENT_TLS_CERT_FILE: certs/clients/client.crt
      CLIENT_TLS_KEY_FILE: certs/clients/client.key
      WORKFLOWS_SERVICE_HOST: workflows-service
      WORKFLOWS_SERVICE_PORT: 50052
      WORKFLOWS_SERVICE_TLS_ENABLED: true
      WORKFLOWS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      JOBS_SERVICE_HOST: jobs-service
      JOBS_SERVICE_PORT: 50053
      JOBS_SERVICE_TLS_ENABLED: true
      JOBS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      NOTIFICATIONS_SERVICE_HOST: notifications-service
      NOTIFICATIONS_SERVICE_PORT: 50054
      NOTIFICATIONS_SERVICE_TLS_ENABLED: true
      NOTIFICATIONS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      DOCKER_HOST: tcp://docker-proxy:2375
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      docker-proxy:
        condition: service_started
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
      workflows-service:
        condition: service_healthy
      jobs-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
    networks:
      - chronoverse

  execution-worker:
    <<: *high-resources-workers-limit
    image: ghcr.io/hitesh22rana/chronoverse/execution-worker:latest
    environment:
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_CONSUMER_GROUP: execution-worker
      CLIENT_TLS_CERT_FILE: certs/clients/client.crt
      CLIENT_TLS_KEY_FILE: certs/clients/client.key
      WORKFLOWS_SERVICE_HOST: workflows-service
      WORKFLOWS_SERVICE_PORT: 50052
      WORKFLOWS_SERVICE_TLS_ENABLED: true
      WORKFLOWS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      JOBS_SERVICE_HOST: jobs-service
      JOBS_SERVICE_PORT: 50053
      JOBS_SERVICE_TLS_ENABLED: true
      JOBS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      NOTIFICATIONS_SERVICE_HOST: notifications-service
      NOTIFICATIONS_SERVICE_PORT: 50054
      NOTIFICATIONS_SERVICE_TLS_ENABLED: true
      NOTIFICATIONS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      DOCKER_HOST: tcp://docker-proxy:2375
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      docker-proxy:
        condition: service_started
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
      workflows-service:
        condition: service_healthy
      jobs-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
    networks:
      - chronoverse

  joblogs-processor:
    <<: *low-resources-workers-limit
    image: ghcr.io/hitesh22rana/chronoverse/joblogs-processor:latest
    environment:
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      CLICKHOUSE_HOSTS: clickhouse:9440
      CLICKHOUSE_USERNAME: chronoverse-client
      CLICKHOUSE_PASSWORD: chronoverse
      CLICKHOUSE_TLS_ENABLED: true
      CLICKHOUSE_TLS_CA_FILE: certs/ca/ca.crt
      CLICKHOUSE_TLS_CERT_FILE: certs/clients/client.crt
      CLICKHOUSE_TLS_KEY_FILE: certs/clients/client.key
      MEILISEARCH_URI: https://meilisearch:7700
      MEILISEARCH_MASTER_KEY: 35b09c3c7b1001ed1fbed7db29a155d0201ab22d527b41bfba9003da7bb3b404
      MEILISEARCH_TLS_ENABLED: true
      MEILISEARCH_TLS_CA_FILE: certs/ca/ca.crt
      MEILISEARCH_TLS_CERT_FILE: certs/clients/client.crt
      MEILISEARCH_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_CONSUMER_GROUP: joblogs-processor
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  analytics-processor:
    <<: *low-resources-workers-limit
    image: ghcr.io/hitesh22rana/chronoverse/analytics-processor:latest
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: primary
      POSTGRES_PASSWORD: chronoverse
      POSTGRES_DB: chronoverse
      POSTGRES_TLS_ENABLED: true
      POSTGRES_TLS_CA_FILE: certs/ca/ca.crt
      POSTGRES_TLS_CERT_FILE: certs/clients/client.crt
      POSTGRES_TLS_KEY_FILE: certs/clients/client.key
      POSTGRES_MIN_CONNS: 2
      KAFKA_BROKERS: kafka:9094
      KAFKA_TLS_ENABLED: true
      KAFKA_TLS_CA_FILE: certs/ca/ca.crt
      KAFKA_TLS_CERT_FILE: certs/clients/client.crt
      KAFKA_TLS_KEY_FILE: certs/clients/client.key
      KAFKA_CONSUMER_GROUP: analytics-processor
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      lgtm:
        condition: service_started
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
    networks:
      - chronoverse

  server:
    <<: *services-limit
    image: ghcr.io/hitesh22rana/chronoverse/server:latest
    container_name: server
    environment:
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 80
      REDIS_HOST: redis
      REDIS_TLS_ENABLED: true
      REDIS_TLS_CA_FILE: certs/ca/ca.crt
      REDIS_TLS_CERT_FILE: certs/clients/client.crt
      REDIS_TLS_KEY_FILE: certs/clients/client.key
      CLIENT_TLS_CERT_FILE: certs/clients/client.crt
      CLIENT_TLS_KEY_FILE: certs/clients/client.key
      USERS_SERVICE_HOST: users-service
      USERS_SERVICE_PORT: 50051
      USERS_SERVICE_TLS_ENABLED: true
      USERS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      WORKFLOWS_SERVICE_HOST: workflows-service
      WORKFLOWS_SERVICE_PORT: 50052
      WORKFLOWS_SERVICE_TLS_ENABLED: true
      WORKFLOWS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      JOBS_SERVICE_HOST: jobs-service
      JOBS_SERVICE_PORT: 50053
      JOBS_SERVICE_TLS_ENABLED: true
      JOBS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      NOTIFICATIONS_SERVICE_HOST: notifications-service
      NOTIFICATIONS_SERVICE_PORT: 50054
      NOTIFICATIONS_SERVICE_TLS_ENABLED: true
      NOTIFICATIONS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      ANALYTICS_SERVICE_HOST: analytics-service
      ANALYTICS_SERVICE_PORT: 50055
      ANALYTICS_SERVICE_TLS_ENABLED: true
      ANALYTICS_SERVICE_TLS_CA_FILE: certs/ca/ca.crt
      OTEL_EXPORTER_OTLP_ENDPOINT: http://lgtm:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      ENV: production
    restart: on-failure
    volumes:
      - ./certs:/certs:ro
    entrypoint: |
      sh -c '
      while [ ! -f /certs/auth.ed ] || [ ! -f /certs/auth.ed.pub ]; do 
        echo "Waiting for certificates..."
        sleep 1
      done
      exec /bin/service
      '
    depends_on:
      redis:
        condition: service_healthy
      init-certs:
        condition: service_completed_successfully
      init-database-migration:
        condition: service_completed_successfully
      users-service:
        condition: service_healthy
      workflows-service:
        condition: service_healthy
      jobs-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
      analytics-service:
        condition: service_healthy
    networks:
      - chronoverse

  dashboard:
    image: ghcr.io/hitesh22rana/chronoverse/dashboard:latest
    container_name: dashboard
    restart: on-failure
    depends_on:
      server:
        condition: service_started
      scheduling-worker:
        condition: service_started
      workflow-worker:
        condition: service_started
      execution-worker:
        condition: service_started
      joblogs-processor:
        condition: service_started
      analytics-processor:
        condition: service_started
    networks:
      - chronoverse

  nginx:
    image: nginx:alpine3.22
    container_name: nginx
    tmpfs:
      - /etc/nginx/conf.d
    entrypoint: |
      sh -c '
      cat > /etc/nginx/nginx.conf << "EOF"
      events {}

      http {
          server {
              listen 80;

              location / {
                  proxy_pass http://dashboard:3000;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
              }

              # Special configuration for SSE events endpoint
              location ~ ^/api/workflows/[^/]+/jobs/[^/]+/events$$ {
                  rewrite ^/api/(.*)$$ /$$1 break;
                  proxy_pass http://server:8080;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;

                  # SSE specific settings
                  proxy_buffering off;
                  proxy_cache off;
                  proxy_set_header Connection "";
                  proxy_http_version 1.1;
                  chunked_transfer_encoding off;

                  # Prevent timeouts for long-running connections
                  proxy_read_timeout 24h;
                  proxy_send_timeout 24h;
                  proxy_connect_timeout 60s;
              }

              location /api/ {
                  proxy_pass http://server:8080/;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;

                  # Standard proxy settings with buffering enabled
                  proxy_buffering on;
                  proxy_cache off;

                  # Standard API timeouts
                  proxy_read_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_connect_timeout 10s;
              }
          }
      }
      EOF
      exec nginx -g "daemon off;"
      '
    ports:
      - "80:80"
    depends_on:
      dashboard:
        condition: service_started
      server:
        condition: service_healthy
    restart: on-failure
    networks:
      - chronoverse

volumes:
  postgres:
  clickhouse:
  redis:
  meilisearch:
  kafka:
  kafka-secrets:
  lgtm:
  otel-lgtm:

networks:
  chronoverse:
    name: chronoverse
    driver: bridge
